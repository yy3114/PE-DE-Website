# 選項 1: 簡單的資料結構
ejaculation_data = {
    "PE": {
        "name": "早發性射精 (Premature Ejaculation)",
        "definition": "持續或反覆於陰道插入後短時間（通常 ≤1 分鐘）即射精",
        "prevalence": "20-30%",
        "causes": ["心理因素", "神經敏感性增加", "5-HT異常", "甲狀腺亢進"],
        "treatment": ["行為治療", "心理治療", "SSRI", "達泊西汀"]
    },
    "DE": {
        "name": "延遲性射精 (Delayed Ejaculation)", 
        "definition": "需長時間性刺激（>20–25分鐘）或無法射精",
        "prevalence": "1-4%",
        "causes": ["心理因素", "神經傳導異常", "SSRI副作用", "內分泌異常"],
        "treatment": ["停藥", "心理治療", "增加刺激", "多巴胺促進劑"]
    }
}

# 選項 2: 類別導向設計
class EjaculationDisorder:
    def __init__(self, name, definition, prevalence, causes, treatments):
        self.name = name
        self.definition = definition
        self.prevalence = prevalence
        self.causes = causes
        self.treatments = treatments
    
    def display_info(self):
        print(f"疾病: {self.name}")
        print(f"定義: {self.definition}")
        print(f"盛行率: {self.prevalence}")
        print(f"原因: {', '.join(self.causes)}")
        print(f"治療: {', '.join(self.treatments)}\n")

# 選項 3: 資料庫風格 (SQLite)
import sqlite3

def create_medical_db():
    conn = sqlite3.connect('medical_conditions.db')
    c = conn.cursor()
    
    c.execute('''CREATE TABLE IF NOT EXISTS conditions
                (id INTEGER PRIMARY KEY, 
                 name TEXT, 
                 type TEXT,
                 definition TEXT,
                 prevalence TEXT)''')
    
    c.execute('''CREATE TABLE IF NOT EXISTS treatments
                (id INTEGER PRIMARY KEY,
                 condition_id INTEGER,
                 treatment TEXT,
                 FOREIGN KEY (condition_id) REFERENCES conditions (id))''')
    
    # 插入資料
    pe_data = (1, '早發性射精', 'PE', '持續或反覆於陰道插入後短時間即射精', '20-30%')
    de_data = (2, '延遲性射精', 'DE', '需長時間性刺激或無法射精', '1-4%')
    
    c.execute('INSERT OR REPLACE INTO conditions VALUES (?,?,?,?,?)', pe_data)
    c.execute('INSERT OR REPLACE INTO conditions VALUES (?,?,?,?,?)', de_data)
    
    conn.commit()
    return conn

# 選項 4: API 風格 (Flask)
from flask import Flask, jsonify

app = Flask(__name__)

@app.route('/conditions/<condition_type>')
def get_condition(condition_type):
    if condition_type.upper() == 'PE':
        return jsonify(ejaculation_data['PE'])
    elif condition_type.upper() == 'DE':
        return jsonify(ejaculation_data['DE'])
    else:
        return jsonify({"error": "Condition not found"}), 404

# 選項 5: 資料分析 (Pandas)
import pandas as pd

def create_comparison_df():
    data = {
        '項目': ['定義', '盛行率', '主要原因', '主要治療'],
        '早發性射精': [
            '≤1分鐘即射精',
            '20-30%',
            '心理因素、神經敏感',
            'SSRI、行為治療'
        ],
        '延遲性射精': [
            '>20-25分鐘才射精',
            '1-4%', 
            'SSRI副作用、神經病變',
            '停藥、多巴胺促進劑'
        ]
    }
    return pd.DataFrame(data)

# 使用範例
if __name__ == "__main__":
    print("=== 選項 1: 簡單資料結構 ===")
    print(f"PE盛行率: {ejaculation_data['PE']['prevalence']}")
    
    print("\n=== 選項 2: 物件導向 ===")
    pe = EjaculationDisorder(
        "早發性射精", "≤1分鐘射精", "20-30%",
        ["心理因素", "神經敏感"], ["SSRI", "行為治療"]
    )
    pe.display_info()
    
    print("=== 選項 5: 資料分析 ===")
    df = create_comparison_df()
    print(df)                '項目': '臨床重點',
                condition.name_zh: condition.clinical_notes
            })
        
        return pd.DataFrame(data)
    
    def to_markdown(self) -> str:
        """生成 Markdown 表格"""
        markdown = "# 射精功能障礙比較表\n\n"
        markdown += "| 項目 | Premature Ejaculation（早發性射精） | Delayed Ejaculation（延遲性射精） |\n"
        markdown += "|------|-------------------------------------|-----------------------------------|\n"
        
        pe = self.conditions['premature_ejaculation']
        de = self.conditions['delayed_ejaculation']
        
        rows = [
            ('**定義**', pe.definition, de.definition),
            ('**常見分類**', '<br>• '.join([''] + pe.classification), '<br>• '.join([''] + de.classification)),
            ('**流行病學**', pe.epidemiology, de.epidemiology),
            ('**主要原因**', '<br>• '.join([''] + pe.causes), '<br>• '.join([''] + de.causes)),
            ('**診斷依據**', pe.diagnosis, de.diagnosis),
            ('**治療**', '<br>• '.join([''] + pe.treatment), '<br>• '.join([''] + de.treatment)),
            ('**臨床重點**', pe.clinical_notes, de.clinical_notes)
        ]
        
        for row in rows:
            markdown += f"| {row[0]} | {row[1]} | {row[2]} |\n"
        
        return markdown
    
    def to_json(self) -> str:
        """匯出為 JSON 格式"""
        json_data = {}
        for key, condition in self.conditions.items():
            json_data[key] = {
                'name_zh': condition.name_zh,
                'name_en': condition.name_en,
                'definition': condition.definition,
                'classification': condition.classification,
                'epidemiology': condition.epidemiology,
                'causes': condition.causes,
                'diagnosis': condition.diagnosis,
                'treatment': condition.treatment,
                'clinical_notes': condition.clinical_notes
            }
        return json.dumps(json_data, ensure_ascii=False, indent=2)
    
    def search_condition(self, keyword: str) -> List[str]:
        """搜尋相關疾病資訊"""
        results = []
        for key, condition in self.conditions.items():
            # 搜尋所有文字欄位
            searchable_text = ' '.join([
                condition.name_zh, condition.name_en, condition.definition,
                ' '.join(condition.causes), condition.diagnosis,
                ' '.join(condition.treatment), condition.clinical_notes
            ])
            
            if keyword.lower() in searchable_text.lower():
                results.append(f"{condition.name_zh} ({condition.name_en})")
        
        return results

# 使用範例
if __name__ == "__main__":
    # 創建表格生成器
    generator = MedicalTableGenerator(ejaculation_disorders)
    
    # 生成不同格式的輸出
    print("=== Markdown 格式 ===")
    print(generator.to_markdown())
    
    print("\n=== JSON 格式 ===")
    print(generator.to_json())
    
    print("\n=== 搜尋功能測試 ===")
    print("搜尋 'SSRI':", generator.search_condition('SSRI'))
    print("搜尋 '心理':", generator.search_condition('心理'))
    
    # 儲存為檔案
    with open('ejaculation_disorders.md', 'w', encoding='utf-8') as f:
        f.write(generator.to_markdown())
    
    with open('ejaculation_disorders.json', 'w', encoding='utf-8') as f:
        f.write(generator.to_json())
    
    print("\n檔案已儲存：ejaculation_disorders.md 和 ejaculation_disorders.json")
